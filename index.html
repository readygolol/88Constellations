<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>88æ˜Ÿåº§è‹±æ–‡ç‰¹è¨“ç­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 3D ç¿»è½‰å¡ç‰‡æ•ˆæœ */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.6s; }
        .card-flipped .card-inner { transform: rotateY(180deg); }
        
        /* å‹•ç•« */
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out; }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        
        /* ç…™ç« Canvas */
        #fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        /* æ˜Ÿç©ºèƒŒæ™¯ */
        body {
            background-color: #0f172a; /* æ·±è—è‰²èƒŒæ™¯ */
            color: #e2e8f0;
        }
    </style>
</head>
<body class="font-sans min-h-screen">

    <canvas id="fireworks"></canvas>
    <div id="app"></div>

    <script>
        // ==========================================
        //  1. è³‡æ–™å€ (88 æ˜Ÿåº§ The 88 Constellations)
        // ==========================================
        const toeicData = [
            { id: 1, word: "Andromeda", chinese: "ä»™å¥³åº§", sentence: "The Andromeda Galaxy is visible within this constellation.", synonyms: "The Chained Maiden", type: "noun" },
            { id: 2, word: "Antlia", chinese: "å”§ç­’åº§", sentence: "Antlia represents an air pump.", synonyms: "The Air Pump", type: "noun" },
            { id: 3, word: "Apus", chinese: "å¤©ç‡•åº§", sentence: "Apus is a faint constellation in the southern sky.", synonyms: "The Bird of Paradise", type: "noun" },
            { id: 4, word: "Aquarius", chinese: "å¯¶ç“¶åº§", sentence: "Aquarius is one of the zodiac constellations.", synonyms: "The Water Bearer", type: "noun" },
            { id: 5, word: "Aquila", chinese: "å¤©é·¹åº§", sentence: "The bright star Altair is in Aquila.", synonyms: "The Eagle", type: "noun" },
            { id: 6, word: "Ara", chinese: "å¤©å£‡åº§", sentence: "Ara lies between Scorpius and Triangulum Australe.", synonyms: "The Altar", type: "noun" },
            { id: 7, word: "Aries", chinese: "ç™½ç¾Šåº§", sentence: "Aries is the first sign of the zodiac.", synonyms: "The Ram", type: "noun" },
            { id: 8, word: "Auriga", chinese: "å¾¡å¤«åº§", sentence: "Capella is the brightest star in Auriga.", synonyms: "The Charioteer", type: "noun" },
            { id: 9, word: "Bootes", chinese: "ç‰§å¤«åº§", sentence: "Bootes contains the red giant star Arcturus.", synonyms: "The Herdsman", type: "noun" },
            { id: 10, word: "Caelum", chinese: "é›•å…·åº§", sentence: "Caelum is a small and faint constellation.", synonyms: "The Chisel", type: "noun" },
            { id: 11, word: "Camelopardalis", chinese: "é¹¿è±¹åº§", sentence: "Camelopardalis represents a giraffe.", synonyms: "The Giraffe", type: "noun" },
            { id: 12, word: "Cancer", chinese: "å·¨èŸ¹åº§", sentence: "Cancer is known as the faintest zodiac constellation.", synonyms: "The Crab", type: "noun" },
            { id: 13, word: "Canes Venatici", chinese: "çµçŠ¬åº§", sentence: "Canes Venatici represents the hunting dogs of Bootes.", synonyms: "The Hunting Dogs", type: "noun" },
            { id: 14, word: "Canis Major", chinese: "å¤§çŠ¬åº§", sentence: "Sirius, the brightest star in the sky, is in Canis Major.", synonyms: "The Great Dog", type: "noun" },
            { id: 15, word: "Canis Minor", chinese: "å°çŠ¬åº§", sentence: "Procyon is the brightest star in Canis Minor.", synonyms: "The Lesser Dog", type: "noun" },
            { id: 16, word: "Capricornus", chinese: "æ‘©ç¾¯åº§", sentence: "Capricornus is often depicted as a sea-goat.", synonyms: "The Sea Goat", type: "noun" },
            { id: 17, word: "Carina", chinese: "èˆ¹åº•åº§", sentence: "Canopus, the second brightest star, is in Carina.", synonyms: "The Keel", type: "noun" },
            { id: 18, word: "Cassiopeia", chinese: "ä»™ååº§", sentence: "Cassiopeia forms a distinctive 'W' shape in the sky.", synonyms: "The Queen", type: "noun" },
            { id: 19, word: "Centaurus", chinese: "åŠäººé¦¬åº§", sentence: "Alpha Centauri is the closest star system to us.", synonyms: "The Centaur", type: "noun" },
            { id: 20, word: "Cepheus", chinese: "ä»™ç‹åº§", sentence: "Cepheus is named after a king of Aethiopia.", synonyms: "The King", type: "noun" },
            { id: 21, word: "Cetus", chinese: "é¯¨é­šåº§", sentence: "Cetus is often referred to as the Sea Monster.", synonyms: "The Whale", type: "noun" },
            { id: 22, word: "Chamaeleon", chinese: "è˜èœ“åº§", sentence: "Chamaeleon is located near the south celestial pole.", synonyms: "The Chameleon", type: "noun" },
            { id: 23, word: "Circinus", chinese: "åœ“è¦åº§", sentence: "Circinus represents a drafting compass.", synonyms: "The Compass", type: "noun" },
            { id: 24, word: "Columba", chinese: "å¤©é´¿åº§", sentence: "Columba represents the dove of Noah.", synonyms: "The Dove", type: "noun" },
            { id: 25, word: "Coma Berenices", chinese: "åé«®åº§", sentence: "Coma Berenices means 'Berenice's Hair'.", synonyms: "Berenice's Hair", type: "noun" },
            { id: 26, word: "Corona Australis", chinese: "å—å†•åº§", sentence: "Corona Australis forms a wreath shape.", synonyms: "The Southern Crown", type: "noun" },
            { id: 27, word: "Corona Borealis", chinese: "åŒ—å†•åº§", sentence: "Corona Borealis is a small but recognizable semicircular arc.", synonyms: "The Northern Crown", type: "noun" },
            { id: 28, word: "Corvus", chinese: "çƒé´‰åº§", sentence: "Corvus is a small constellation in the southern sky.", synonyms: "The Crow", type: "noun" },
            { id: 29, word: "Crater", chinese: "å·¨çˆµåº§", sentence: "Crater represents the cup of the god Apollo.", synonyms: "The Cup", type: "noun" },
            { id: 30, word: "Crux", chinese: "å—åå­—åº§", sentence: "Crux is the smallest of all 88 constellations.", synonyms: "The Southern Cross", type: "noun" },
            { id: 31, word: "Cygnus", chinese: "å¤©éµåº§", sentence: "Cygnus contains the famous Northern Cross asterism.", synonyms: "The Swan", type: "noun" },
            { id: 32, word: "Delphinus", chinese: "æµ·è±šåº§", sentence: "Delphinus looks like a leaping dolphin.", synonyms: "The Dolphin", type: "noun" },
            { id: 33, word: "Dorado", chinese: "åŠé­šåº§", sentence: "The Large Magellanic Cloud is in Dorado.", synonyms: "The Swordfish", type: "noun" },
            { id: 34, word: "Draco", chinese: "å¤©é¾åº§", sentence: "Draco winds around the Little Dipper.", synonyms: "The Dragon", type: "noun" },
            { id: 35, word: "Equuleus", chinese: "å°é¦¬åº§", sentence: "Equuleus is the second smallest constellation.", synonyms: "The Little Horse", type: "noun" },
            { id: 36, word: "Eridanus", chinese: "æ³¢æ±Ÿåº§", sentence: "Eridanus is represented as a river flowing south.", synonyms: "The River", type: "noun" },
            { id: 37, word: "Fornax", chinese: "å¤©çˆåº§", sentence: "Fornax represents a chemical furnace.", synonyms: "The Furnace", type: "noun" },
            { id: 38, word: "Gemini", chinese: "é›™å­åº§", sentence: "The two bright stars Castor and Pollux are in Gemini.", synonyms: "The Twins", type: "noun" },
            { id: 39, word: "Grus", chinese: "å¤©é¶´åº§", sentence: "Grus is known as the Crane.", synonyms: "The Crane", type: "noun" },
            { id: 40, word: "Hercules", chinese: "æ­¦ä»™åº§", sentence: "The Great Globular Cluster is located in Hercules.", synonyms: "The Hero", type: "noun" },
            { id: 41, word: "Horologium", chinese: "æ™‚é˜åº§", sentence: "Horologium represents a pendulum clock.", synonyms: "The Clock", type: "noun" },
            { id: 42, word: "Hydra", chinese: "é•·è›‡åº§", sentence: "Hydra is the largest of the 88 constellations.", synonyms: "The Water Snake", type: "noun" },
            { id: 43, word: "Hydrus", chinese: "æ°´è›‡åº§", sentence: "Hydrus is a small constellation in the deep southern sky.", synonyms: "The Male Water Snake", type: "noun" },
            { id: 44, word: "Indus", chinese: "å°ç¬¬å®‰åº§", sentence: "Indus represents an indigenous person.", synonyms: "The Indian", type: "noun" },
            { id: 45, word: "Lacerta", chinese: "è è™åº§", sentence: "Lacerta is a small constellation in the northern sky.", synonyms: "The Lizard", type: "noun" },
            { id: 46, word: "Leo", chinese: "ç…å­åº§", sentence: "Regulus is the heart of the lion in Leo.", synonyms: "The Lion", type: "noun" },
            { id: 47, word: "Leo Minor", chinese: "å°ç…åº§", sentence: "Leo Minor lies between Leo and Ursa Major.", synonyms: "The Lesser Lion", type: "noun" },
            { id: 48, word: "Lepus", chinese: "å¤©å…”åº§", sentence: "Lepus lies just under the feet of Orion.", synonyms: "The Hare", type: "noun" },
            { id: 49, word: "Libra", chinese: "å¤©ç§¤åº§", sentence: "Libra is the only zodiac sign represented by an object.", synonyms: "The Scales", type: "noun" },
            { id: 50, word: "Lupus", chinese: "è±ºç‹¼åº§", sentence: "Lupus is located between Centaurus and Scorpius.", synonyms: "The Wolf", type: "noun" },
            { id: 51, word: "Lynx", chinese: "å¤©è²“åº§", sentence: "Lynx is a faint constellation in the northern sky.", synonyms: "The Lynx", type: "noun" },
            { id: 52, word: "Lyra", chinese: "å¤©ç´åº§", sentence: "Vega, a very bright star, is part of Lyra.", synonyms: "The Harp", type: "noun" },
            { id: 53, word: "Mensa", chinese: "å±±æ¡ˆåº§", sentence: "Mensa is named after Table Mountain in South Africa.", synonyms: "The Table Mountain", type: "noun" },
            { id: 54, word: "Microscopium", chinese: "é¡¯å¾®é¡åº§", sentence: "Microscopium is a small constellation in the southern sky.", synonyms: "The Microscope", type: "noun" },
            { id: 55, word: "Monoceros", chinese: "éº’éºŸåº§", sentence: "Monoceros lies on the celestial equator.", synonyms: "The Unicorn", type: "noun" },
            { id: 56, word: "Musca", chinese: "è’¼è …åº§", sentence: "Musca is a small constellation near the Southern Cross.", synonyms: "The Fly", type: "noun" },
            { id: 57, word: "Norma", chinese: "çŸ©å°ºåº§", sentence: "Norma represents a carpenter's square.", synonyms: "The Level", type: "noun" },
            { id: 58, word: "Octans", chinese: "å—æ¥µåº§", sentence: "The South Celestial Pole is located in Octans.", synonyms: "The Octant", type: "noun" },
            { id: 59, word: "Ophiuchus", chinese: "è›‡å¤«åº§", sentence: "Ophiuchus is often called the 13th zodiac sign.", synonyms: "The Serpent Bearer", type: "noun" },
            { id: 60, word: "Orion", chinese: "çµæˆ¶åº§", sentence: "Orion is one of the most recognizable constellations.", synonyms: "The Hunter", type: "noun" },
            { id: 61, word: "Pavo", chinese: "å­”é›€åº§", sentence: "Pavo is known for its bright star Peacock.", synonyms: "The Peacock", type: "noun" },
            { id: 62, word: "Pegasus", chinese: "é£›é¦¬åº§", sentence: "The Great Square is the main feature of Pegasus.", synonyms: "The Winged Horse", type: "noun" },
            { id: 63, word: "Perseus", chinese: "è‹±ä»™åº§", sentence: "Perseus contains the variable star Algol.", synonyms: "The Hero", type: "noun" },
            { id: 64, word: "Phoenix", chinese: "é³³å‡°åº§", sentence: "Phoenix is named after the mythical bird.", synonyms: "The Phoenix", type: "noun" },
            { id: 65, word: "Pictor", chinese: "ç¹ªæ¶åº§", sentence: "Pictor represents an easel.", synonyms: "The Painter's Easel", type: "noun" },
            { id: 66, word: "Pisces", chinese: "é›™é­šåº§", sentence: "Pisces represents two fish tied together.", synonyms: "The Fishes", type: "noun" },
            { id: 67, word: "Piscis Austrinus", chinese: "å—é­šåº§", sentence: "Fomalhaut is the bright star in Piscis Austrinus.", synonyms: "The Southern Fish", type: "noun" },
            { id: 68, word: "Puppis", chinese: "èˆ¹å°¾åº§", sentence: "Puppis was originally part of Argo Navis.", synonyms: "The Stern", type: "noun" },
            { id: 69, word: "Pyxis", chinese: "ç¾…ç›¤åº§", sentence: "Pyxis represents a mariner's compass.", synonyms: "The Compass", type: "noun" },
            { id: 70, word: "Reticulum", chinese: "ç¶²ç½Ÿåº§", sentence: "Reticulum is a small constellation in the southern sky.", synonyms: "The Reticle", type: "noun" },
            { id: 71, word: "Sagitta", chinese: "å¤©ç®­åº§", sentence: "Sagitta is the third smallest constellation.", synonyms: "The Arrow", type: "noun" },
            { id: 72, word: "Sagittarius", chinese: "äººé¦¬åº§", sentence: "The center of the Milky Way lies in Sagittarius.", synonyms: "The Archer", type: "noun" },
            { id: 73, word: "Scorpius", chinese: "å¤©è åº§", sentence: "Antares is the red heart of Scorpius.", synonyms: "The Scorpion", type: "noun" },
            { id: 74, word: "Sculptor", chinese: "ç‰å¤«åº§", sentence: "The South Galactic Pole is in Sculptor.", synonyms: "The Sculptor", type: "noun" },
            { id: 75, word: "Scutum", chinese: "ç›¾ç‰Œåº§", sentence: "Scutum is a small constellation in the Milky Way.", synonyms: "The Shield", type: "noun" },
            { id: 76, word: "Serpens", chinese: "å·¨è›‡åº§", sentence: "Serpens is the only constellation split into two parts.", synonyms: "The Serpent", type: "noun" },
            { id: 77, word: "Sextans", chinese: "å…­åˆ†å„€åº§", sentence: "Sextans sits near the celestial equator.", synonyms: "The Sextant", type: "noun" },
            { id: 78, word: "Taurus", chinese: "é‡‘ç‰›åº§", sentence: "Taurus contains the Pleiades star cluster.", synonyms: "The Bull", type: "noun" },
            { id: 79, word: "Telescopium", chinese: "æœ›é é¡åº§", sentence: "Telescopium honors the invention of the telescope.", synonyms: "The Telescope", type: "noun" },
            { id: 80, word: "Triangulum", chinese: "ä¸‰è§’åº§", sentence: "The Triangulum Galaxy is found here.", synonyms: "The Triangle", type: "noun" },
            { id: 81, word: "Triangulum Australe", chinese: "å—ä¸‰è§’åº§", sentence: "Triangulum Australe is a small southern constellation.", synonyms: "The Southern Triangle", type: "noun" },
            { id: 82, word: "Tucana", chinese: "æœéµ‘åº§", sentence: "The Small Magellanic Cloud is in Tucana.", synonyms: "The Toucan", type: "noun" },
            { id: 83, word: "Ursa Major", chinese: "å¤§ç†Šåº§", sentence: "The Big Dipper is part of Ursa Major.", synonyms: "The Great Bear", type: "noun" },
            { id: 84, word: "Ursa Minor", chinese: "å°ç†Šåº§", sentence: "Polaris, the North Star, is in Ursa Minor.", synonyms: "The Little Bear", type: "noun" },
            { id: 85, word: "Vela", chinese: "èˆ¹å¸†åº§", sentence: "Vela represents the sails of a ship.", synonyms: "The Sails", type: "noun" },
            { id: 86, word: "Virgo", chinese: "å®¤å¥³åº§", sentence: "Virgo is the second largest constellation.", synonyms: "The Virgin", type: "noun" },
            { id: 87, word: "Volans", chinese: "é£›é­šåº§", sentence: "Volans represents a flying fish.", synonyms: "The Flying Fish", type: "noun" },
            { id: 88, word: "Vulpecula", chinese: "ç‹ç‹¸åº§", sentence: "The Dumbbell Nebula is located in Vulpecula.", synonyms: "The Fox", type: "noun" }
        ];

        // ==========================================
        //  2. ç¨‹å¼é‚è¼¯å€
        // ==========================================
        
        let currentPage = 'home'; 
        let currentSettings = { count: 10, type: 1 };
        
        let learnIndex = 0;
        
        let gameData = [];
        let gameIndex = 0;
        let score = 0;
        let timer = 0;
        let timerInterval = null;
        let selectedCards = []; 
        let matchedPairs = []; 
        let gameActive = false;

        // æ–°å¢ï¼šç›®å‰é€™é¡ŒéŒ¯äº†å¹¾æ¬¡
        let currentAttempts = 0;
        const MAX_ATTEMPTS = 3; // ç¸½å…±æœ‰ 3 æ¬¡æ©Ÿæœƒ (1æ¬¡åŸå§‹ + 2æ¬¡é‡è©¦)

        // --- å·¥å…·å‡½å¼ ---

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        const correctEncouragements = ["Correct!", "Stellar!", "Out of this world!", "Amazing!", "Perfect!"];
        const wrongEncouragements = ["Try again!", "Keep looking up!", "Don't give up!", "Almost there!"];

        // ç…™ç«æ•ˆæœ
        const canvas = document.getElementById('fireworks');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function triggerFireworks() {
            const colors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA'];
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x, y,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    radius: Math.random() * 4 + 1,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 100,
                    alpha: 1
                });
            }
            animateFireworks();
        }

        function animateFireworks() {
            if (particles.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            requestAnimationFrame(animateFireworks);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach((p, index) => {
                if (p.life > 0) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    p.alpha -= 0.01;
                } else {
                    particles.splice(index, 1);
                }
            });
        }

        function showFeedback(isCorrect, msg) {
            const div = document.createElement('div');
            div.className = "fixed inset-0 flex items-center justify-center z-50 bg-black/60 backdrop-blur-sm animate-fade-in";
            div.innerHTML = `
                <div class="p-8 rounded-3xl shadow-2xl transform scale-110 flex flex-col items-center animate-bounce-short ${isCorrect ? 'bg-slate-800 border-4 border-green-400' : 'bg-slate-800 border-4 border-pink-400'}">
                    <div class="text-6xl mb-4 ${isCorrect ? 'text-green-400' : 'text-pink-400'}">
                        <i data-lucide="${isCorrect ? 'check' : 'heart'}"></i>
                    </div>
                    <h2 class="text-3xl font-black ${isCorrect ? 'text-green-400' : 'text-pink-400'}">
                        ${msg}
                    </h2>
                </div>
            `;
            document.body.appendChild(div);
            try { lucide.createIcons(); } catch(e){}
            
            if(isCorrect) triggerFireworks();

            setTimeout(() => {
                div.remove();
            }, 1000);
        }

        // --- ç•«é¢æ¸²æŸ“å‡½å¼ ---

        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 

            if (currentPage === 'home') renderHome(app);
            else if (currentPage === 'learn') renderLearn(app);
            else if (currentPage === 'practice_menu') renderPracticeMenu(app);
            else if (currentPage === 'practice_game') renderGame(app);
            else if (currentPage === 'result') renderResult(app);
            
            try { lucide.createIcons(); } catch (e) {}
        }

        function renderHome(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6 space-y-8 text-center">
                    <div class="bg-slate-800 p-8 rounded-3xl shadow-xl border-4 border-blue-400 max-w-md w-full">
                        <h1 class="text-4xl font-black text-white mb-2 tracking-tight">88 Constellations</h1>
                        <h2 class="text-2xl font-bold text-blue-300 mb-6">88æ˜Ÿåº§è‹±æ–‡ç‰¹è¨“</h2>
                        <div class="space-y-4">
                            <button onclick="goToLearn()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl text-xl font-bold shadow-md transition-all transform hover:scale-105 flex items-center justify-center gap-3">
                                <i data-lucide="book-open"></i> å­¸ç¿’æ˜Ÿåº§
                            </button>
                            <button onclick="goToMenu()" class="w-full py-4 bg-purple-600 hover:bg-purple-500 text-white rounded-2xl text-xl font-bold shadow-md transition-all transform hover:scale-105 flex items-center justify-center gap-3">
                                <i data-lucide="brain"></i> æ¸¬é©—ç·´ç¿’
                            </button>
                        </div>
                    </div>
                    <p class="text-slate-400 font-medium">æ¢ç´¢å…¨å¤©88å€‹æ˜Ÿåº§ï¼</p>
                </div>
            `;
        }

        function renderLearn(container) {
            if (!toeicData || toeicData.length === 0) {
                container.innerHTML = "<div class='p-10 text-white'>è®€å–ä¸åˆ°è³‡æ–™</div>";
                return;
            }
            
            const word = toeicData[learnIndex];
            container.innerHTML = `
                <div class="min-h-screen flex flex-col items-center pt-8 pb-4">
                    <div class="w-full max-w-md px-4 flex justify-between items-center mb-6">
                        <button onclick="goHome()" class="bg-slate-700 p-2 rounded-full shadow text-white hover:bg-slate-600"><i data-lucide="rotate-ccw"></i></button>
                        <h2 class="text-2xl font-bold text-white">æ˜Ÿåº§å¡ (${learnIndex + 1}/${toeicData.length})</h2>
                        <div class="w-10"></div>
                    </div>

                    <div class="relative w-full max-w-xs h-96 perspective-1000 mb-8 cursor-pointer group" onclick="this.classList.toggle('card-flipped')">
                        <div class="card-inner relative w-full h-full transform-style-3d w-full h-full">
                            <div class="absolute w-full h-full bg-slate-800 rounded-3xl shadow-2xl border-b-8 border-blue-500 backface-hidden flex flex-col items-center justify-center p-6 text-center text-white">
                                <span class="text-6xl mb-6">ğŸŒŸ</span>
                                <h3 class="text-4xl font-bold mb-4">${word.word}</h3>
                                <button onclick="event.stopPropagation(); speak('${word.word}')" class="bg-blue-600 text-white p-4 rounded-full hover:bg-blue-500 transition-colors">
                                    <i data-lucide="volume-2" width="32" height="32"></i>
                                </button>
                                <p class="mt-6 text-slate-400 text-sm">(é»æ“Šç¿»é¢)</p>
                            </div>
                            <div class="absolute w-full h-full bg-white rounded-3xl shadow-2xl border-b-8 border-purple-500 backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6 text-center text-slate-800">
                                <h3 class="text-3xl font-bold text-purple-600 mb-2">${word.chinese}</h3>
                                <div class="w-full h-0.5 bg-slate-200 my-4"></div>
                                <p class="text-slate-600 italic mb-4">"${word.sentence}"</p>
                                <div class="bg-orange-50 px-3 py-2 rounded-lg">
                                    <p class="text-xs text-orange-400 font-bold uppercase">Meaning</p>
                                    <p class="text-orange-600 text-sm font-bold">${word.synonyms}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-6">
                        <button onclick="prevLearnCard()" class="px-6 py-3 bg-slate-700 text-white rounded-xl shadow font-bold hover:bg-slate-600">ä¸Šä¸€å¼µ</button>
                        <button onclick="nextLearnCard()" class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow font-bold hover:bg-blue-500">ä¸‹ä¸€å¼µ</button>
                    </div>
                </div>
            `;
        }

        function renderPracticeMenu(container) {
            const counts = [10, 20, 40, 88];
            let countBtns = counts.map(num => 
                `<button onclick="setGameCount(${num})" class="py-2 rounded-lg font-bold transition-all ${currentSettings.count === num ? 'bg-blue-500 text-white scale-110' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">${num}</button>`
            ).join('');

            const options = [
                {t:1, title:"è½éŸ³é¸ä¸­æ–‡", icon:"ğŸ§", desc:"Listening - Chinese", color:"blue"},
                {t:2, title:"è½éŸ³é¸è‹±æ–‡", icon:"ğŸ” ", desc:"Listening - English", color:"purple"},
                {t:3, title:"çœ‹è‹±é¸ä¸­", icon:"ğŸ‘ï¸", desc:"Reading - Chinese", color:"pink"},
                {t:4, title:"è½éŸ³é…å°", icon:"ğŸ§©", desc:"Audio Match", color:"orange"},
                {t:5, title:"æ–‡å­—é…å°", icon:"ğŸƒ", desc:"Word Match", color:"green"},
                {t:6, title:"æ˜Ÿåº§æè¿°", icon:"ğŸ“", desc:"Fill in blanks", color:"red"}
            ];

            let gameBtns = options.map(opt => {
                const colorClass = {
                    blue: 'bg-blue-900 text-blue-200 hover:bg-blue-800 border-blue-700',
                    purple: 'bg-purple-900 text-purple-200 hover:bg-purple-800 border-purple-700',
                    pink: 'bg-pink-900 text-pink-200 hover:bg-pink-800 border-pink-700',
                    orange: 'bg-orange-900 text-orange-200 hover:bg-orange-800 border-orange-700',
                    green: 'bg-emerald-900 text-emerald-200 hover:bg-emerald-800 border-emerald-700',
                    red: 'bg-red-900 text-red-200 hover:bg-red-800 border-red-700',
                }[opt.color];
                return `<button onclick="startGame(${opt.t})" class="flex flex-col items-center p-4 rounded-2xl border-b-4 transition-all transform hover:translate-y-1 ${colorClass}">
                    <span class="text-3xl mb-2">${opt.icon}</span>
                    <span class="font-bold text-lg">${opt.title}</span>
                    <span class="text-xs opacity-70">${opt.desc}</span>
                </button>`;
            }).join('');

            container.innerHTML = `
                <div class="min-h-screen flex flex-col items-center p-6">
                    <button onclick="goHome()" class="self-start mb-6 bg-slate-700 px-4 py-2 rounded-lg text-white font-bold shadow flex items-center gap-2 hover:bg-slate-600"><i data-lucide="rotate-ccw" width="16"></i> è¿”å›</button>
                    <h2 class="text-3xl font-bold text-white mb-8">é¸æ“‡ç·´ç¿’æ¨¡å¼</h2>
                    <div class="w-full max-w-lg space-y-6">
                        <div class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                            <h3 class="text-lg font-bold text-slate-300 mb-3 flex items-center gap-2"><i data-lucide="settings" width="20"></i> é¡Œæ•¸è¨­å®š</h3>
                            <div class="grid grid-cols-4 gap-2">${countBtns}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${gameBtns}</div>
                    </div>
                </div>
            `;
        }

        function renderGame(container) {
            const isPairing = currentSettings.type === 4 || currentSettings.type === 5;
            
            let contentHtml = '';
            if (isPairing) {
                contentHtml = renderPairingBoard();
            } else {
                contentHtml = renderQuizCard();
            }

            container.innerHTML = `
                <div class="min-h-screen flex flex-col relative overflow-hidden">
                    <div class="bg-slate-800 p-4 shadow-sm flex justify-between items-center z-10 sticky top-0 border-b border-slate-700">
                        <button onclick="goToMenu()" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2 bg-blue-900 text-blue-200 px-3 py-1 rounded-full font-bold text-sm">
                                <i data-lucide="clock" width="16"></i> <span id="timerDisplay">${formatTime(timer)}</span>
                            </div>
                            ${!isPairing ? `
                            <div class="flex items-center gap-2 bg-pink-900 text-pink-200 px-3 py-1 rounded-full font-bold text-sm">
                                <i data-lucide="star" width="16"></i> ${score} / ${currentSettings.count}
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col items-center justify-center p-4 z-10 w-full max-w-4xl mx-auto">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        function renderQuizCard() {
            const q = gameData[gameIndex];
            const type = currentSettings.type;
            
            let options = [q];
            let distractors = toeicData.filter(i => i.id !== q.id).sort(() => 0.5 - Math.random()).slice(0, 3);
            options = options.concat(distractors).sort(() => 0.5 - Math.random());

            if ((type === 1 || type === 2) && currentAttempts === 0) setTimeout(() => speak(q.word), 100);

            let questionDisplay = '';
            if (type === 1) questionDisplay = `<button onclick="speak('${q.word}')" class="bg-blue-700 p-6 rounded-full text-white hover:bg-blue-600 transition mb-4 shadow-lg"><i data-lucide="volume-2" width="48" height="48"></i></button><p class="text-slate-400">è½éŸ³é¸ä¸­æ–‡</p>`;
            else if (type === 2) questionDisplay = `<button onclick="speak('${q.word}')" class="bg-purple-700 p-6 rounded-full text-white hover:bg-purple-600 transition mb-4 shadow-lg"><i data-lucide="volume-2" width="48" height="48"></i></button><p class="text-slate-400">è½éŸ³é¸è‹±æ–‡</p>`;
            else if (type === 3) questionDisplay = `<h2 class="text-4xl font-black text-white tracking-wide">${q.word}</h2><p class="mt-4 text-slate-400">çœ‹è‹±æ–‡é¸ä¸­æ–‡</p>`;
            else if (type === 6) {
                const parts = q.sentence.split(new RegExp(`\\b${q.word}\\b`, 'i'));
                const sentenceHtml = parts.map((p, i) => i < parts.length - 1 ? `${p}<span class="inline-block w-24 border-b-4 border-pink-500 mx-1"></span>` : p).join('');
                questionDisplay = `<div class="text-xl text-white font-medium text-left leading-relaxed bg-slate-800 p-6 rounded-2xl border border-slate-700">${sentenceHtml}</div><p class="mt-6 text-slate-400 text-sm">é¸å‡ºç¼ºç©ºçš„æ˜Ÿåº§å</p>`;
            }

            // ä¿®æ”¹ï¼šåŠ å…¥ this åƒæ•¸å‚³éæŒ‰éˆ•æœ¬èº«
            const optionsHtml = options.map(opt => `
                <button onclick="checkAnswer(${opt.id}, this)" class="bg-slate-800 p-4 rounded-xl shadow-md border-2 border-slate-700 hover:border-pink-500 hover:bg-slate-700 transition-all text-slate-200 font-bold text-lg min-h-[64px] disabled:opacity-50 disabled:cursor-not-allowed">
                    ${(type === 1 || type === 3) ? opt.chinese : opt.word}
                </button>
            `).join('');

            return `
                <div class="w-full max-w-md">
                    <div class="w-full h-2 bg-slate-700 rounded-full mb-8 overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500" style="width: ${((gameIndex + 1) / currentSettings.count) * 100}%"></div>
                    </div>
                    <div class="bg-slate-800 rounded-3xl shadow-xl p-8 mb-6 text-center border-b-8 border-blue-600 relative">
                        <span class="absolute top-4 left-4 bg-slate-700 text-slate-300 px-3 py-1 rounded-lg text-xs font-bold">Q${gameIndex + 1}</span>
                        <div class="py-4">${questionDisplay}</div>
                    </div>
                    <div class="grid grid-cols-1 gap-3">${optionsHtml}</div>
                </div>
            `;
        }

        function renderPairingBoard() {
            const cardsHtml = gameData.map((card, idx) => {
                const isMatched = matchedPairs.includes(card.itemId);
                const isSelected = selectedCards.some(c => c.uid === card.uid);
                
                const colors = ['bg-pink-300', 'bg-blue-300', 'bg-purple-300', 'bg-green-300', 'bg-yellow-300'];
                const matchColor = isMatched ? colors[card.itemId % colors.length] : 'bg-white';
                
                let content = `<span class="text-slate-800 font-bold">${card.content}</span>`;
                if(currentSettings.type === 4 && card.type === 'question') {
                    content = `<i data-lucide="volume-2" class="${isSelected?'text-orange-600':'text-blue-600'}" width="32"></i>`;
                }
                if(isMatched) content = `<i data-lucide="check" class="text-slate-800 opacity-50"></i>`;

                let className = "aspect-square rounded-2xl shadow-sm border-b-4 flex items-center justify-center p-2 transition-all duration-300 text-sm md:text-base font-bold ";
                if(isMatched) className += `${matchColor} border-transparent opacity-80 scale-95`;
                else if(isSelected) className += `bg-orange-200 border-orange-400 -translate-y-1`;
                else className += `bg-white border-slate-300 hover:bg-slate-100`;

                return `<button onclick="handlePairClick(${idx})" ${isMatched ? 'disabled' : ''} class="${className}">${content}</button>`;
            }).join('');

            return `
                <div class="w-full max-w-5xl">
                    <div class="text-center mb-4">
                        <p class="text-slate-400">é…å°æ‰€æœ‰å¡ç‰‡ï¼ (${matchedPairs.length} / ${currentSettings.count} çµ„)</p>
                    </div>
                    <div class="grid grid-cols-4 md:grid-cols-5 gap-3">${cardsHtml}</div>
                </div>
            `;
        }

        function renderResult(container) {
            const percentage = (score / currentSettings.count) * 100;
            let stars = 1;
            if (percentage > 50) stars = 2;
            if (percentage > 80) stars = 3;

            const starHtml = [1,2,3].map(i => 
                `<i data-lucide="star" width="48" height="48" class="${i <= stars ? "text-yellow-400 fill-yellow-400" : "text-slate-600"}"></i>`
            ).join('');

            container.innerHTML = `
                <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-blue-500 animate-bounce-short">
                    <div class="mb-6 flex justify-center gap-2">${starHtml}</div>
                    <h2 class="text-3xl font-black text-white mb-2">ç·´ç¿’å®Œæˆï¼</h2>
                    <p class="text-slate-400 mb-8">å®‡å®™ç´šçš„è¡¨ç¾ï¼ç¹¼çºŒä¿æŒï¼</p>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-blue-900 p-4 rounded-2xl">
                            <p class="text-blue-300 text-xs font-bold uppercase">Score</p>
                            <p class="text-3xl font-bold text-white">${score} <span class="text-lg opacity-50">/ ${currentSettings.count}</span></p>
                        </div>
                        <div class="bg-purple-900 p-4 rounded-2xl">
                            <p class="text-purple-300 text-xs font-bold uppercase">Time</p>
                            <p class="text-3xl font-bold text-white">${formatTime(timer)}</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="startGame(${currentSettings.type})" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-500 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="rotate-ccw" width="20"></i> å†ç©ä¸€æ¬¡
                        </button>
                        <button onclick="goToMenu()" class="w-full py-4 bg-slate-700 text-slate-200 border-2 border-slate-600 rounded-xl font-bold hover:bg-slate-600 transition-all">
                            æ›´æ›æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;
        }

        // --- äº’å‹•æ§åˆ¶å‡½å¼ ---

        function goHome() { currentPage = 'home'; renderApp(); }
        function goToLearn() { currentPage = 'learn'; learnIndex = 0; renderApp(); }
        function goToMenu() { 
            stopTimer(); 
            currentPage = 'practice_menu'; 
            renderApp(); 
        }

        function nextLearnCard() {
            learnIndex = (learnIndex + 1) % toeicData.length;
            renderApp();
        }
        function prevLearnCard() {
            learnIndex = (learnIndex - 1 + toeicData.length) % toeicData.length;
            renderApp();
        }

        function setGameCount(n) {
            currentSettings.count = n;
            renderApp();
        }

        function startGame(type) {
            currentSettings.type = type;
            score = 0;
            timer = 0;
            gameIndex = 0;
            currentAttempts = 0; // é‡ç½®å˜—è©¦æ¬¡æ•¸
            matchedPairs = [];
            selectedCards = [];
            gameActive = true;
            
            let shuffled = [...toeicData].sort(() => 0.5 - Math.random());
            let selected = shuffled.slice(0, currentSettings.count);

            if (type === 4 || type === 5) {
                let pairs = [];
                selected.forEach((item, idx) => {
                    pairs.push({
                        uid: `q-${item.id}`,
                        itemId: item.id,
                        content: type === 4 ? 'audio' : item.word,
                        type: 'question',
                        word: item.word
                    });
                    pairs.push({
                        uid: `a-${item.id}`,
                        itemId: item.id,
                        content: item.chinese,
                        type: 'answer'
                    });
                });
                gameData = pairs.sort(() => 0.5 - Math.random());
            } else {
                gameData = selected;
            }

            currentPage = 'practice_game';
            renderApp();
            startTimer();
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timer++;
                const el = document.getElementById('timerDisplay');
                if(el) el.innerText = formatTime(timer);
            }, 1000);
        }
        function stopTimer() {
            if(timerInterval) clearInterval(timerInterval);
        }

        // ä¿®æ”¹ï¼šåŠ å…¥ retry é‚è¼¯ï¼Œä¸¦æ¥æ”¶ btnElement åƒæ•¸
        function checkAnswer(selectedId, btnElement) {
            if(!gameActive) return;
            const correctId = gameData[gameIndex].id;
            
            if (selectedId === correctId) {
                // ç­”å°äº†
                score++;
                showFeedback(true, correctEncouragements[Math.floor(Math.random() * correctEncouragements.length)]);
                moveToNextQuestion();
            } else {
                // ç­”éŒ¯äº†
                currentAttempts++;
                
                // è¦–è¦ºå›é¥‹ï¼šå°‡æŒ‰éˆ•è®Šç´…ä¸¦ç¦ç”¨
                if (btnElement) {
                    btnElement.classList.remove('bg-slate-800', 'hover:bg-slate-700', 'border-slate-700');
                    btnElement.classList.add('bg-red-900', 'text-red-200', 'border-red-600', 'opacity-80');
                    btnElement.disabled = true;
                }

                if (currentAttempts >= MAX_ATTEMPTS) {
                    // æ©Ÿæœƒç”¨ç›¡
                    showFeedback(false, "æ²’é—œä¿‚ï¼Œä¸‹ä¸€é¡Œï¼");
                    moveToNextQuestion();
                } else {
                    // é‚„æœ‰æ©Ÿæœƒï¼Œåœç•™åœ¨ç•¶å‰é é¢
                    showFeedback(false, `å†è©¦è©¦ï¼é‚„æœ‰ ${MAX_ATTEMPTS - currentAttempts} æ¬¡æ©Ÿæœƒ`);
                }
            }
        }

        // æ–°å¢ï¼šåˆ‡æ›åˆ°ä¸‹ä¸€é¡Œçš„ç¨ç«‹å‡½å¼
        function moveToNextQuestion() {
            setTimeout(() => {
                if (gameIndex < currentSettings.count - 1) {
                    gameIndex++;
                    currentAttempts = 0; // é‡ç½®å˜—è©¦æ¬¡æ•¸
                    renderApp();
                } else {
                    finishGame();
                }
            }, 1000);
        }

        function handlePairClick(cardIndex) {
            const card = gameData[cardIndex];
            
            if(matchedPairs.includes(card.itemId)) return;
            if(selectedCards.some(c => c.uid === card.uid)) return;
            if(selectedCards.length >= 2) return;

            if(currentSettings.type === 4 && card.type === 'question') {
                speak(card.word);
            }

            selectedCards.push(card);
            renderApp(); 

            if(selectedCards.length === 2) {
                const [c1, c2] = selectedCards;
                if (c1.itemId === c2.itemId) {
                    score++;
                    matchedPairs.push(c1.itemId);
                    showFeedback(true, "é…å°æˆåŠŸï¼");
                    selectedCards = [];
                    renderApp();

                    if (matchedPairs.length === currentSettings.count) {
                        setTimeout(finishGame, 1000);
                    }
                } else {
                    setTimeout(() => {
                        selectedCards = [];
                        renderApp();
                    }, 1000);
                }
            }
        }

        function finishGame() {
            gameActive = false;
            stopTimer();
            currentPage = 'result';
            renderApp();
        }

        // --- ç¨‹å¼é€²å…¥é» ---
        renderApp();

    </script>
</body>
</html>
